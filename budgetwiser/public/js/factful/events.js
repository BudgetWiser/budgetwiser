Factful.e = {}, Factful.m = {};Factful.e.checkRange = function(){    var _tempRange = new Factful.Range(),        _ch = _tempRange.check();    if(_ch.state){        $(Factful.leftSide).unbind('mouseup', Factful.e.checkRange);        var _r = _ch.range.cloneRange();        _tempRange._range = _r;        _tempRange._paragraph = _r.startContainer.parentElement.id;        var _pre = _r.cloneRange();        _pre.selectNodeContents(_r.startContainer.parentElement);        _pre.setEnd(_r.startContainer, _r.startOffset);        _tempRange.start = _pre.toString().length;        _tempRange.end = _tempRange.start + _r.toString().length;        _tempRange.normalize();        window.getSelection().removeAllRanges();        // Find Similar Range from server        $.ajax({            url: '/factful/api',            type: 'GET',            data: { _id: _tempRange._paragraph, type: 'ranges'},            success: function(objList){                _tempRange.findSimilarRange(objList, function(_obj){                    if(!_obj._id){                        _obj._id = 'temp-range';                        _obj.generateView(Factful.content.offset());                    }                    Factful.e.openRangeMenu({data:{_range: _obj}});                });            },            error: function(xhr){                throw Error(xhr);            }        });    }else{        console.log('no range');    }};Factful.e.enterRange = function(e){    var _r = e.data._range;    var overStyle = 'rgba(0, 132, 255, .15)';    _r.backView_.map(function(_obj){        $(_obj).css('background', overStyle);    });};Factful.e.leaveRange = function(e){    var _r = e.data._range;    var leaveStyle = 'transparent';    _r.backView_.map(function(_obj){        $(_obj).css('background', leaveStyle);    });};Factful.e.openRangeMenu = function(e){    console.log('openRangeMenu');    if(Factful.article.activeRange_){        Factful.e.closeRangeMenu(Factful.article.activeRange_);    }    Factful.article.activeRange_ = e;    var _r = e.data._range;    var openStyle = 'rgba(255, 228, 0, .5)';    _r.backView_.map(function(_obj){        $(_obj).css('background', openStyle);    });    _r.view_.map(function(_obj){        $(_obj).unbind('mouseenter', Factful.e.enterRange);        $(_obj).unbind('mouseleave', Factful.e.leaveRange);        $(_obj).unbind('click', Factful.e.openRangeMenu);        //        $(_obj).bind('click', {_range: _r}, Factful.e.closeRangeMenu);        //        $(_obj).addClass('active-range');    });    $(Factful.leftSide).bind('mousedown.closeRange', {_range: _r}, function(e){        if($(e.target).hasClass('factful-article-ranges')){            Factful.e.closeRangeMenu(e);        }        if($(e.target).hasClass('factful-article-range') && $(e.target).hasClass('temp-range')){            Factful.e.closeRangeMenu(e);        }    });    // RangeMenu Events    $(_r.menuView_.view_).fadeIn(150);    $(_r.menuView_.addComment.open_).bind('click', {_range: _r}, Factful.e.openAddComment);    $(_r.menuView_.addFactcheck.open_).bind('click', {_range: _r}, Factful.e.openAddFactcheck);    $(_r.menuView_.addFactcheckReq.open_).bind('click', {_range: _r}, Factful.e.openAddFactcheckReq);};Factful.e.closeRangeMenu = function(e){    console.log('closeRangeMenu');    var _r = e.data._range;    var closeStyle = 'transparent';    _r.backView_.map(function(_obj){        $(_obj).css('background', closeStyle);    });    _r.view_.map(function(_obj){        $(_obj).unbind('click', Factful.e.closeRangeMenu);        //        $(_obj).bind('mouseenter', {_range: _r}, Factful.e.enterRange);        $(_obj).bind('mouseleave', {_range: _r}, Factful.e.leaveRange);        $(_obj).bind('click', {_range: _r}, Factful.e.openRangeMenu);        //        $(_obj).removeClass('active-range');    });    if(_r._id == 'temp-range'){        _r.remove();    }    Factful.article.activeRange_ = '';    //$(Factful.leftSide).bind('mouseup', Factful.e.checkRange);    $(Factful.leftSide).unbind('mousedown.closeRange');    // RangeMenu Events    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.open_).unbind('click', Factful.e.openAddComment);    $(_r.menuView_.addFactcheck.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addFactcheck.open_).unbind('click', Factful.e.openAddFactcheck);    $(_r.menuView_.addFactcheckReq.open_).unbind('click', Factful.e.openAddFactcheckReq);};Factful.e.openAddComment = function(e){    console.log('openAddComment');    var _r = e.data._range;    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.view_).fadeIn(150);    $(_r.menuView_.addComment.submit_).unbind('click');    $(_r.menuView_.addComment.submit_).bind('click', {_range: _r}, Factful.e.addComment);};Factful.e.openAddFactcheck = function(e){    console.log(e.data._range._id, 'openAddFactcheck');    var _r = e.data._range;    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addFactcheck.view_).fadeIn(150);    $(_r.menuView_.addFactcheck.submit_).unbind('click');    $(_r.menuView_.addFactcheck.submit_).bind('click', {_range: _r}, Factful.e.addFactcheck);};Factful.e.openAddFactcheckReq = function(e){    Factful.e.addFactcheckReq(e.data._range);};Factful.e.addComment = function(e){    var _range = e.data._range;    Factful.e.saveRange(_range, function(_r){        Factful.e.saveComment(_r);    });};Factful.e.addFactcheck = function(e){    var _range = e.data._range;    Factful.e.saveRange(_range, function(_r){        Factful.e.saveFactcheck(_r);    });};Factful.e.addFactcheckReq = function(_range){    Factful.e.saveRange(_range, function(_r){        Factful.e.saveFactcheckReq(_r);    });};Factful.e.saveRange = function(_range, callback){    var _r = _range;    if(_r._id == 'temp-range'){        var data = {            _paragraph: _r._paragraph,            start: _r.start,            end: _r.end        };        var save = $.ajax({            type: 'POST',            url: '/factful/add/range',            data: data        });        save.done(function(obj){            _r._id = obj.range._id;            if (callback) callback(_r);        });        save.fail(function(xhr){            console.log(xhr.responseText);        });        }else{        if (callback) callback(_r);    }};Factful.e.saveComment = function(_range, callback){    var _r = _range;    var data = {        _range: _r._id,        content: $(_r.menuView_.addComment.textbox_).val()    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/comment',        data: data    });    save.done(function(obj){        if (callback) callback(obj);        $(_r.menuView_.addComment.textbox_).val('');        Factful.e.closeRangeMenu({data: {_range: _r}});        alert('comment is saved!');    });    save.fail(function(xhr){        console.log(xhr.responseText);    });};Factful.e.saveFactcheck = function(_range, callback){    var _r = _range;    var score = $(_r.menuView_.addFactcheck.view_).children()[2];    var data = {        _range: _r._id,        score: $(score).val(),        ref: $(_r.menuView_.addFactcheck.link_).val()    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/factcheck',        data: data    });    save.done(function(obj){        if (callback) callback(obj);        $(_r.menuView_.addFactcheck.score_).val('');        $(_r.menuView_.addFactcheck.link_).val('');        Factful.e.closeRangeMenu({data: {_range: _r}});                alert('Your factchecking is saved successfully.')    });    save.fail(function(xhr){        console.log(xhr.responseText);    });};Factful.e.saveFactcheckReq = function(_range, callback){    var _r = _range;    var data = {        _range: _r._id    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/factcheckreq',        data: data    });    save.done(function(obj){        if (callback) callback(obj);        Factful.e.closeRangeMenu({data: {_range: _r}});                if(obj.statusCode == 0){            alert('Requested!');        }else if(obj.statusCode == 1){            alert('You already requested about this phrase.');        }    });    save.fail(function(xhr){        console.log(xhr.responseText);    });};