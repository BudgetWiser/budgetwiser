Factful.e = {}, Factful.m = {};/* * Check highlight */Factful.e.checkRange = function(){    var _tempRange = new Factful.Range(),        _ch = _tempRange.check();    if(_ch.state){        $(Factful.leftSide).unbind('mouseup', Factful.e.checkRange);        var _r = _ch.range.cloneRange();        _tempRange._range = _r;        _tempRange._paragraph = _r.startContainer.parentElement.id;        var _pre = _r.cloneRange();        _pre.selectNodeContents(_r.startContainer.parentElement);        _pre.setEnd(_r.startContainer, _r.startOffset);        _tempRange.start = _pre.toString().length;        _tempRange.end = _tempRange.start + _r.toString().length;        _tempRange.normalize();        window.getSelection().removeAllRanges();        // Find Similar Range from server        $.ajax({            url: '/factful/api',            type: 'GET',            data: { _id: _tempRange._paragraph, type: 'ranges'},            success: function(objList){                _tempRange.findSimilarRange(objList, function(_obj){                    if(!_obj._id){                        _obj._id = 'temp-range';                        _obj.generateView(Factful.content.offset());                    }                    Factful.e.openRangeMenu({data:{_range: _obj}});                });            },            error: function(xhr){                throw Error(xhr);            }        });    }};/* * Mouseenter Event for range objects */Factful.e.enterRange = function(e){    var _r = e.data._range;    var overStyle = 'rgba(0, 132, 255, .15)';    _r.backView_.map(function(_obj){        $(_obj).css('background', overStyle);    });    Factful.e.fadeInComments(e);};/* * Mouseleave Event for range objects */Factful.e.leaveRange = function(e){    var _r = e.data._range;    var leaveStyle = 'transparent';    _r.backView_.map(function(_obj){        $(_obj).css('background', leaveStyle);    });    Factful.e.fadeOutComments(e);};/* * Mouseclick Event for range objects - OPEN */Factful.e.openRangeMenu = function(e){    var _r = e.data._range;    var openStyle = 'rgba(255, 228, 0, .5)';    if(!$(_r.view_).hasClass('temp-range')) Factful.e.openComments(e);    if(Factful.e.activeRange_){        Factful.e.closeRangeMenu({data:{_range:Factful.e.activeRange_}});    }    Factful.e.activeRange_ = e.data._range;    _r.view_.map(function(_obj){        $(_obj).unbind('mouseenter', Factful.e.enterRange)               .unbind('mouseleave', Factful.e.leaveRange)               .unbind('click', Factful.e.openRangeMenu)               .bind('click', {_range: _r}, Factful.e.closeRangeMenu)               .addClass('active-range');    });    _r.backView_.map(function(_obj){        $(_obj).css('background', openStyle);    });    $(Factful.leftSide).bind('mousedown.closeRange', {_range: _r}, function(e){        var _t = $(e.target);        if(_t.hasClass('factful-article-ranges')){            Factful.e.closeRangeMenu(e);        }        if(_t.hasClass('factful-article-range') && _t.hasClass('temp-range')){            Factful.e.closeRangeMenu(e);        }    });    $(_r.menuView_.view_).fadeIn(150);    $(_r.menuView_.addComment.open_).bind('click', {_range: _r}, Factful.e.openAddComment);    $(_r.menuView_.addFactcheck.open_).bind('click', {_range: _r}, Factful.e.openAddFactcheck);    $(_r.menuView_.addFactcheckReq.open_).bind('click', {_range: _r}, Factful.e.openAddFactcheckReq);};/* * Mouseclick Event for range objects - CLOSE */Factful.e.closeRangeMenu = function(e){    var _r = e.data._range;    var _g = Factful.comments.groups[_r._id];    var closeStyle = 'transparent';    if(!$(_r.view_).hasClass('temp-range')) Factful.e.closeComments(e);    Factful.e.activeRange_ = '';    _r.view_.map(function(_obj){        $(_obj).bind('mouseenter', {_range: _r}, Factful.e.enterRange)               .bind('mouseleave', {_range: _r}, Factful.e.leaveRange)               .unbind('click', Factful.e.closeRangeMenu)               .bind('click', {_range: _r}, Factful.e.openRangeMenu)               .removeClass('active-range');    });    _r.backView_.map(function(_obj){        $(_obj).css('background', closeStyle);    });    if(_r._id == 'temp-range') _r.remove();    $(Factful.leftSide).unbind('mousedown.closeRange');    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.open_).unbind('click', Factful.e.openAddComment);    $(_r.menuView_.addFactcheck.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addFactcheck.open_).unbind('click', Factful.e.openAddFactcheck);    $(_r.menuView_.addFactcheckReq.open_).unbind('click', Factful.e.openAddFactcheckReq);};/* * Mouseclick Event for comment */Factful.e.openAddComment = function(e){    console.log('openAddComment');    var _r = e.data._range;    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addComment.view_).fadeIn(150);    $(_r.menuView_.addComment.submit_).unbind('click');    $(_r.menuView_.addComment.submit_).bind('click', {_range: _r}, Factful.e.addComment);};/* * Mouseclick Event for factcheck */Factful.e.openAddFactcheck = function(e){    console.log(e.data._range._id, 'openAddFactcheck');    var _r = e.data._range;    $(_r.menuView_.view_).fadeOut(150, function(){$(this).hide()});    $(_r.menuView_.addFactcheck.view_).fadeIn(150);    $(_r.menuView_.addFactcheck.submit_).unbind('click');    $(_r.menuView_.addFactcheck.submit_).bind('click', {_range: _r}, Factful.e.addFactcheck);};/* * Mouseclick Event for factcheck request */Factful.e.openAddFactcheckReq = function(e){    Factful.e.addFactcheckReq(e.data._range);};/* * Add Comment */Factful.e.addComment = function(e){    var _range = e.data._range;    Factful.e.saveRange(_range, function(_r){        Factful.e.saveComment(_r, function(_savedComment){            var data = {                _id: _savedComment._id,                _comment: _savedComment._comment,                _user: _savedComment._user,                username: _savedComment.username,                nickname: _savedComment.nickname,                _range: _r._id,                date: _savedComment.date,                content: _savedComment.content,                ref: _savedComment.ref,                symp: _savedComment.symp,                child: _savedComment.child,            };            var comment = new Factful.Comment(data);            var commentsGroup = Factful.comments.groups[_r._id];            comment.generateView(commentsGroup.view_);            comment.eventHandlers();            $(commentsGroup.view_).show().animate({                'opacity': 1            }, 200);            $(comment.view_).animate({                'backgroundColor': '#fff8df'            }, 300, function(){                $(this).delay(200).animate({                    'backgroundColor': '#fff'                }, 800);            });            commentsGroup.items.push(comment);        });    });};/* * Open Comment Comment */Factful.e.openCommentComment = function(e){    var _c = e.data._comment;    $(_c.addView_).show();};/* * Add Comment Comment */Factful.e.addCommentComment = function(e){    var _c = e.data._comment;    Factful.e.saveCommentComment(_c, function(_savedCocomment){        var data = {            _id: _savedCocomment._id,            _comment: _savedCocomment._comment,            _user: _savedCocomment._user,            username: _savedCocomment.username,            nickname: _savedCocomment.nickname,            date: _savedCocomment.date,            content: _savedCocomment.content,            ref: _savedCocomment.ref,            symp: _savedCocomment.symp        };        var cocomment = new Factful.CoComment(data);        var comment = _c;        _c.child += 1;        _c.addBtn_.innerHTML = '<span>댓글달기</span> ' + _c.child + '명';        cocomment.generateView(comment.groupsView_);        cocomment.eventHandlers();        $(cocomment.view_).animate({            'backgroundColor': '#fff8df'        }, 300, function(){            $(this).animate({                'backgroundColor': '#fff'            }, 800);        });    });};/* * Add Factcheck */Factful.e.addFactcheck = function(e){    var _range = e.data._range;    Factful.e.saveRange(_range, function(_r){        Factful.e.saveFactcheck(_r, function(_savedFactcheck){            var data = {                _range : _savedFactcheck._range,                _userList : [_savedFactcheck._user],                fcList : [{                    'user': _savedFactcheck._user,                    'score': _savedFactcheck.score,                    'ref': _savedFactcheck.ref                }]            };            var commentsGroup = Factful.comments.groups[_r._id];            var movePos = 0;            if(commentsGroup.items[0]){                if($(commentsGroup.items[0].view_).hasClass('factful-factcheck-req')){                    $(commentsGroup.items[0].view_).remove();                    commentsGroup.items.removeItem(commentsGroup.items[0]);                    var fc = new Factful.Factcheck(data);                    fc.generateView(commentsGroup.view_);                    commentsGroup.items.unshift(fc);                    movePos = $(fc.view_).height() + 12;                }else if($(commentsGroup.items[0].view_).hasClass('factful-factcheck')){                    var fc = commentsGroup.items[0];                    var fcItemView = Factful.createElement('li');                    var movePos1 = $(fc.view_).height();                    fcItemView.addClass('factful-factcheck-item');                    fcItemView.innerHTML =                        '<span>(' + _savedFactcheck.score + '.0)</span> ' +                        '<a href="' + _savedFactcheck.ref + '">' + _savedFactcheck.ref + '</a>';                    fc.fcListView_.appendChild(fcItemView);                    fc._userList.push(_savedFactcheck._user);                    fc.sum += _savedFactcheck.score;                    var avgScore = fc.sum / fc._userList.length;                    fc.fcView_.innerHTML = '사실 확인 <span>' + fc._userList.length + '명</span><span class="factful-factcheck-score">평균 ' + avgScore.toFixed(1) + '점</span>';                    var movePos2 = $(fc.view_).height();                    movePos = movePos2 - movePos1;                }else{                    var fc = new Factful.Factcheck(data);                    fc.generateView(commentsGroup.view_);                    commentsGroup.items.unshift(fc);                    movePos = $(fc.view_).height() + 12;                }            }else{                    console.log('afff');                var fc = new Factful.Factcheck(data);                fc.generateView(commentsGroup.view_);                commentsGroup.items.unshift(fc);                movePos = $(fc.view_).height() + 12;            }            if(commentsGroup.items.length > 1){                $(commentsGroup.view_).show().animate({                    'opaicty': 1,                    'top': '-=' + movePos                }, 200);            }else{                $(commentsGroup.view_).show().animate({                    'opaicty': 1                }, 200);            }            $(commentsGroup.items[0].view_).animate({                'backgroundColor': '#fff8df'            }, 300, function(){                $(this).delay(200).animate({                    'backgroundColor': '#fff'                }, 800);            });        });    });};/* * Add Factcheck Request */Factful.e.addFactcheckReq = function(_range){    Factful.e.saveRange(_range, function(_r){        Factful.e.saveFactcheckReq(_r, function(_savedRequest){            var data = {                _range: _savedRequest._range            };            var commentsGroup = Factful.comments.groups[_r._id];            if(commentsGroup.items[0]){                if(commentsGroup.items[0].view_.hasClass('factful-factcheck-req')){                    var req = commentsGroup.items[0];                    req._userList.push(Factful.User.username);                    req.reqView_.innerHTML = '사실 확인 요청 <span>' + req._userList.length + '명</span>';                }else{                    var req = new Factful.FactcheckReq(data);                    req._userList = [];                    req._userList.push(Factful.User.username);                    req.generateView(commentsGroup.view_);                    var reqTop = 0;                    if(commentsGroup.items.length > 1) reqTop = $(req.view_).height() + 12;                    $(commentsGroup.view_).show().animate({                        'opacity': 1,                        'top': '-=' + reqTop                    }, 200);                    commentsGroup.items.unshift(req);                }            }else{                var req = new Factful.FactcheckReq(data);                req._userList = [];                req._userList.push(Factful.User.username);                req.generateView(commentsGroup.view_);                var reqTop = 0;                if(commentsGroup.items.length > 1) reqTop = $(req.view_).height() + 12;                $(commentsGroup.view_).show().animate({                    'opacity': 1,                    'top': '-=' + reqTop                }, 200);                commentsGroup.items.push(req);            }            $(req.view_).animate({                'backgroundColor': '#fff8df'            }, 300, function(){                $(this).delay(200).animate({                    'backgroundColor': '#fff'                }, 800);            });        });    });};/* * Add Comment Symp */Factful.e.addCommentSymp = function(e){    var _comment = e.data._comment;    Factful.e.saveCommentSymp(_comment);};/* * Save Range */Factful.e.saveRange = function(_range, callback){    var _r = _range;    if(_r._id == 'temp-range'){        var data = {            _paragraph: _r._paragraph,            start: _r.start,            end: _r.end        };        var save = $.ajax({            type: 'POST',            url: '/factful/add/range',            data: data        });        save.done(function(obj){            _r._id = obj.range._id;            $(_r.view_).removeClass('temp-range');            if (callback) callback(_r);        });        save.fail(function(xhr){            console.log(xhr.responseText);        });    }else{        if (callback) callback(_r);    }};/* * Save Comment */Factful.e.saveComment = function(_range, callback){    var _r = _range;    var data = {        _range: _r._id,        content: $(_r.menuView_.addComment.textbox_).val()    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/comment',        data: data    });    save.done(function(obj){        $(_r.menuView_.addComment.textbox_).val('')        $(_r.menuView_.addComment.view_).fadeOut(150, function(){$(this).hide()});        $(_r.menuView_.view_).fadeIn(150);        //Factful.e.closeRangeMenu({data: {_range: _r}});        Factful.feedback(200, '댓글이 저장되었습니다!');        if(!Factful.comments.groups[_range._id]){            //Make commentsGroup View            var commentsView = Factful.createElement('div');            commentsView.addClass(_r._id + ' factful-comments-group closed');            var range_pos = parseInt($(_r.view_[0]).css('top')) - 20;            $(commentsView).css('top', range_pos);            Factful.comments.view_.appendChild(commentsView);            Factful.comments.groups[_range._id] = {'view_': commentsView, 'items': []};        }        if(callback) callback(obj.comment);    });    save.fail(function(xhr){        Factful.feedback(500, '댓글 저장 오류!');        console.log(xhr.responseText);    });};/* * Save CoComment */Factful.e.saveCommentComment = function(_comment, callback){    var _c = _comment;    var data = {        _range: _c._range,        _comment: _c._id,        content: $(_c.addTextarea_).val()    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/cocomment',        data: data    });    save.done(function(obj){        Factful.feedback(200, '대댓글이 성공적으로 저장되었습니다!');        $(_c.addTextarea_).val('');        $(_comment.addView_).hide();        if(callback) callback(obj.cocomment);    });    save.fail(function(xhr){        Factful.feedback(500, '대댓글 저장 오류!');        console.log(xhr.responseText);    });};/* * Save Comment Symp */Factful.e.saveCommentSymp = function(_comment, callback){    var _c = _comment, st;    if(!$(_c.sympBtn_).hasClass('disabled')){        st = true; //add    }else{        st = false; //remove    }    var data = {        _comment: _c._id,        st: st    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/commentsymp',        data: data    });    save.done(function(obj){        if (callback) callback(obj);        if(st){            $(_c.sympBtn_).addClass('disabled');            Factful.feedback(200, '공감하였습니다!');            _c.symp.push(obj.username);            _c.sympBtn_.innerHTML = '<span>공감취소</span> ' + _c.symp.length + '명';        }else{            $(_c.sympBtn_).removeClass('disabled');            Factful.feedback(300, '공감을 취소하였습니다.');            _c.symp.removeItem(obj.username);            _c.sympBtn_.innerHTML = '<span>공감하기</span> ' + _c.symp.length + '명';        }    });    save.fail(function(xhr){        Factful.feedback(500, '공감하기 오류!');        console.log(xhr.responseText);    });};/* * Save Factcheck */Factful.e.saveFactcheck = function(_range, callback){    var _r = _range;    var score = $(_r.menuView_.addFactcheck.view_).children()[2];    var data = {        _range: _r._id,        score: $(score).val(),        ref: $(_r.menuView_.addFactcheck.link_).val()    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/factcheck',        data: data    });    save.done(function(obj){        if(!Factful.comments.groups[_range._id]){            var commentsView = Factful.createElement('div');            commentsView.addClass(_r._id + ' factful-comments-group closed');            var range_pos = parseInt($(_r.view_[0]).css('top')) - 20;            $(commentsView).css('top', range_pos);            Factful.comments.view_.appendChild(commentsView);            Factful.comments.groups[_range._id] = {'view_': commentsView, 'items': []};        }        if (callback) callback(obj.factcheck);        $(_r.menuView_.addFactcheck.score_).val('');        $(_r.menuView_.addFactcheck.link_).val('');        //Factful.e.closeRangeMenu({data: {_range: _r}});        $(_r.menuView_.addFactcheck.view_).fadeOut(150, function(){$(this).hide()});        $(_r.menuView_.view_).fadeIn(150);        Factful.feedback(200, '사실 확인이 성공적으로 저장되었습니다.');    });    save.fail(function(xhr){        Factful.feedback(200, '사실 확인 저장 오류!');        console.log(xhr.responseText);    });};/* * Save Factcheck Request */Factful.e.saveFactcheckReq = function(_range, callback){    var _r = _range;    var data = {        _range: _r._id    };    var save = $.ajax({        type: 'POST',        url: '/factful/add/factcheckreq',        data: data    });    save.done(function(obj){        if(obj.statusCode == 0){            Factful.feedback(200, '사실확인이 성공적으로 요청되었습니다.');        }else if(obj.statusCode == 1){            Factful.feedback(300, '이미 사실확인을 요청하셨습니다.');        }        if(!Factful.comments.groups[_range._id]){            //Make commentsGroup View            var commentsView = Factful.createElement('div');            commentsView.addClass(_r._id + ' factful-comments-group closed');            var range_pos = parseInt($(_r.view_[0]).css('top')) - 20;            $(commentsView).css('top', range_pos);            Factful.comments.view_.appendChild(commentsView);            Factful.comments.groups[_range._id] = {'view_': commentsView, 'items': []};        }        if(obj.statusCode == 0){            if(callback) callback(obj.factcheckreq);        }    });    save.fail(function(xhr){        Factful.feedback(500, '사실확인 요청 오류!');        console.log(xhr.responseText);    });};/* * Fold Event for Budget Information */Factful.e.foldInfo = function(e){    var _info = e.data._info;    if(_info.st == 'open'){        $(_info.view_).css('overflow', 'hidden');        $(_info.view_).animate({            'height': 72        }, 500, function(){            $(_info.foldBtn_).removeClass('to-close').addClass('to-open');            $(_info.view_).addClass('closed');            _info.st = 'close';        });        // for ranges        var deltaHeight = _info.oHeight - 76;        $('.factful-article-range, .factful-article-range-backview, .factful-article-range-menu, .range-add-comment-view, .range-add-factcheck-view').animate({            'top': '-=' + deltaHeight        }, 500);        // for comments        $('.factful-comments-group').animate({            'top': '-=' + deltaHeight        }, 500);    }else{        $(_info.view_).animate({            'height': _info.oHeight        }, 500, function(){            $(_info.view_).css('overflow', 'visible').removeClass('closed');            $(_info.foldBtn_).removeClass('to-open').addClass('to-close');            _info.st = 'open';        });        var deltaHeight = _info.oHeight - 76;        $('.factful-article-range, .factful-article-range-backview, .factful-article-range-menu, .range-add-comment-view, .range-add-factcheck-view').animate({            'top': '+=' + deltaHeight        }, 500);        $('.factful-comments-group').animate({            'top': '+=' + deltaHeight        }, 500);    }};/* * Fold Event for Services Information */Factful.e.foldServices = function(e){    var _services = e.data._services;    if(_services.st == 'open'){        $(_services.view_).css('overflow', 'hidden');        $(_services.view_).animate({            'height': 72        }, 200, function(){            $(_services.foldBtn_).removeClass('to-close').addClass('to-open');            $(_services.view_).addClass('closed');            _services.st = 'close';        });    }else{        $(_services.view_).animate({            'height': _services.oHeight        }, 200, function(){            $(_services.view_).css('overflow', '').removeClass('closed');            $(_services.foldBtn_).removeClass('to-open').addClass('to-close');            _services.st = 'open';        });    }};/* * FadeIn Comments Group */Factful.e.fadeInComments = function(e){    var _r = e.data._range;    var _g = Factful.comments.groups[_r._id];    $(_g.view_).show().stop().animate({        'opacity': .3    }, 100);};/* * FadeOut Comments Group */Factful.e.fadeOutComments = function(e){    var _r = e.data._range;    var _g = Factful.comments.groups[_r._id];    $(_g.view_).stop().animate({        'opacity': 0    }, 100, function(){        $(this).hide();    });};/* * Open Comments Group */Factful.e.openComments = function(e){    var _r = e.data._range;    var _g = Factful.comments.groups[_r._id];    $(_g.view_).show().stop().animate({        'opacity': 1    }, 200).css('z-index', 100);};/* * Close Comments Group */Factful.e.closeComments = function(e){    var _r = e.data._range;    var _g = Factful.comments.groups[_r._id];    $(_g.view_).stop().animate({        'opacity': 0    }, 200, function(){        $(this).hide();        Factful.scroll.moveOrig(_g);    }).css('z-index', 50);};/* * Scroll Event */Factful.m.commentScroll = false;Factful.e.scroll = function(e){    var delta = e.originalEvent.wheelDelta;    if(Factful.e.activeRange_){        var _g = Factful.comments.groups[Factful.e.activeRange_._id];        console.log(_g.move);        if(delta > 0){            Factful.scroll.moveUp(_g);        }else{            Factful.scroll.moveDown(_g);        }    }};